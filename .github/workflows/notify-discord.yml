name: Label PR & Notify Discord

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  label-and-notify:
    runs-on: ubuntu-latest

    steps:
      - name: Run PR Labeler
        uses: technote-space/pr-labeler-action@v1.7.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR Info and Labels
        id: pr_info
        run: |
          title=$(jq -r ".pull_request.title" "$GITHUB_EVENT_PATH")
          url=$(jq -r ".pull_request.html_url" "$GITHUB_EVENT_PATH")
          actor="${{ github.actor }}"

          labels=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")

          emoji="ðŸ“"
          color=3447003

          for label in $labels; do
            case $label in
              feature)
                emoji="âœ¨"
                color=15844367
                ;;
              fix)
                emoji="ðŸ›"
                color=15158332
                ;;
              docs)
                emoji="ðŸ“š"
                color=3447003
                ;;
              refactor)
                emoji="ðŸ› ï¸"
                color=9807270
                ;;
              test)
                emoji="ðŸ§ª"
                color=10181046
                ;;
              chore)
                emoji="ðŸ”§"
                color=10181046
                ;;
              style)
                emoji="ðŸ’„"
                color=10181046
                ;;
              move)
                emoji="ðŸšš"
                color=10181046
                ;;
            esac
          done

          echo "emoji=$emoji" >> $GITHUB_ENV
          echo "color=$color" >> $GITHUB_ENV
          echo "title=$title" >> $GITHUB_ENV
          echo "url=$url" >> $GITHUB_ENV
          echo "actor=$actor" >> $GITHUB_ENV

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          payload=$(jq -n \
            --arg emoji "$emoji" \
            --arg title "$title" \
            --arg url "$url" \
            --arg actor "$actor" \
            --argjson color "$color" \
            '{
              "embeds": [
                {
                  "title": "\($emoji) ìƒˆ Pull Request!",
                  "description": "**ìž‘ì„±ìž-** \($actor)\n**PR Message-** \($title)\nðŸ”— [PR ë³´ëŸ¬ê°€ê¸°](\($url))",
                  "color": $color,
                  "timestamp": now | todateiso8601,
                  "footer": {
                    "text": "GitHub Actions - PR ì•Œë¦¼ë´‡"
                  }
                }
              ]
            }')

          echo "$payload" > payload.json

          curl -H "Content-Type: application/json" \
              -X POST \
              -d @payload.json \
              "$DISCORD_WEBHOOK"
